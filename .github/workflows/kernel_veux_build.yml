name: Build KernelSU-Next for OnePlus-7-Serie

on:
  push:
    branches:
      - veux
  pull_request:
    branches:
      - veux
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container: ghcr.io/tedomi2705/kernel_builder_image:latest

    steps:
      - name: ðŸ“‚ Checkout builder's sourcecode and get files
        uses: actions/checkout@v4
 
      - name: âš¡ Checkout kernel's sourcecode and clone submodules
        run: |
          git clone --depth=1 https://github.com/Evolution-X-Devices/kernel_xiaomi_veux kernel_xiaomi_veux -b vic

      - name: ðŸ“… Export date of build
        run: |
          echo "DATE=$(date +%d%m%Y)" >> $GITHUB_ENV
   
      - name: ðŸ”„ Update KernelSU-Next
        run: |
          cd kernel_xiaomi_veux
          rm -rf KernelSU-Next
          git clone https://github.com/KernelSU-Next/KernelSU-Next -b v1.0.7

      - name: ðŸ” Device's codename and kernel's version
        run: |
          cd kernel_xiaomi_veux
          DEVICE_CODENAME=Veux
          KERNEL_VERSION=$(make kernelversion | grep -E '^[0-9]+\.[0-9]+\.[0-9]+')

          echo "Device Codename: $DEVICE_CODENAME"
          echo "Kernel Version: $KERNEL_VERSION"

          echo "DEVICE_CODENAME=$DEVICE_CODENAME" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV

      - name: ðŸš€ Enable ccache to speed the build up
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          max-size: 7G

      - name: ðŸ› ï¸ Build the kramel
        run: |
          ./build.sh Veux

      - name: Define Anykernel3 properly
        run: |
          cd kernel_xiaomi_veux
          mv AnyKernel3 Anykernel

      - name: ðŸš€ Copy the compiled kernel to AnyKernel3 then create the zip
        run: |
          cd kernel_xiaomi_veux
          ZIP_NAME="Kernel-Paimon-${DEVICE_CODENAME}-${KERNEL_VERSION}-$(date +%d%m%Y).zip"

          cp out/arch/arm64/boot/Image Anykernel/

          cd Anykernel && zip -r9 $ZIP_NAME ./*
          mv $ZIP_NAME ../../

          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: ðŸ¤Œ Copy zip file to get 2 different zip files
        run: |

          ZIP_ALTERNATIVE="KernelSU-Next-Paimon-${DEVICE_CODENAME}-latest.zip"
          cp ${ZIP_NAME} $ZIP_ALTERNATIVE

          echo "Copied ${ZIP_NAME} as $ZIP_ALTERNATIVE"
          echo "ZIP_ALTERNATIVE=$ZIP_ALTERNATIVE" >> $GITHUB_ENV
          
      - name: ðŸ“¤ Publish github release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP_ALTERNATIVE }}
          tag_name: "latest"
          draft: false
          prerelease: false

      - name: ðŸ“¤ Publish with tag associated to the kernel and the date
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP_NAME }}
          tag_name: Kernel-Paimon-${{ env.DEVICE_CODENAME }}-${{ env.KERNEL_VERSION }}-${{ env.DATE }}
          draft: false
          prerelease: false

  notification:
    runs-on: ubuntu-22.04
    needs: build
    steps:

      - name: ðŸ“‚ Checkout builder's sourcecode and get files
        uses: actions/checkout@v4

      - name: ðŸš€ Notify people on Discord
        env:
          DEVICE_CODENAME: Veux
          KERNEL_VERSION: 5.4.292
          WEBHOOK: ${{ secrets.WEBHOOK }}
          NAME: Kernel-Paimon-Veux-5.4.292.zip
        run: |
          python3 .github/webhook.py
